<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>ULTRA RUNNER 3D - Full Version</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        :root { --primary: #3b82f6; --gold: #fbbf24; --danger: #ef4444; --neon: #00f2ff; --bg: #020617; }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Segoe UI', sans-serif; color: white; user-select: none; }
        #ui-layer { position: fixed; inset: 0; z-index: 100; pointer-events: none; }
        .interactive { pointer-events: all; }
        .screen { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(15px); }
        .panel { background: rgba(255, 255, 255, 0.05); padding: 30px; border-radius: 25px; border: 1px solid var(--primary); text-align: center; min-width: 350px; box-shadow: 0 0 40px rgba(59, 130, 246, 0.2); }
        .hud { position: absolute; top: 20px; width: 100%; display: flex; justify-content: space-around; font-size: 22px; font-weight: bold; }
        #ingame-menu-btn { position: absolute; top: 80px; left: 50%; transform: translateX(-50%); }
        h1 { font-size: 40px; margin: 0 0 20px; background: linear-gradient(45deg, var(--primary), var(--neon)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .btn { background: var(--primary); border: none; color: white; padding: 10px 20px; border-radius: 10px; font-size: 16px; cursor: pointer; transition: 0.2s; margin: 5px; width: 80%; font-weight: bold; }
        .btn:hover { background: var(--neon); color: #000; transform: translateY(-2px); }
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .shop-item { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; border: 1px solid transparent; cursor: pointer; font-size: 14px; }
        .shop-item.active { border-color: var(--gold); background: rgba(251, 191, 36, 0.2); }
        .hidden { display: none !important; }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="ui-layer">
        <div id="hud" class="hud hidden">
            <div>SCORE: <span id="scoreVal">0</span></div>
            <div style="color:var(--gold)">ðŸ’° <span id="coinVal">0</span></div>
            <div id="modeDisplay" style="font-size: 14px; color: var(--neon);">MODUS: NORMAL</div>
            <div id="ingame-menu-btn" class="interactive">
                <button class="btn" style="width: auto; padding: 5px 15px; opacity: 0.6;" onclick="location.reload()">MENÃœ</button>
            </div>
        </div>

        <div id="screen-main" class="screen interactive">
            <div class="panel">
                <h1>ULTRA 3D</h1>
                <p>Highscore: <span id="bestVal">0</span> | Coins: <span id="totalCoinsVal" style="color:var(--gold)">0</span></p>
                <button class="btn" onclick="showScreen('screen-modes')">SPIEL STARTEN</button><br>
                <button class="btn" onclick="showScreen('screen-shop')" style="background:#4b5563">SHOP</button>
            </div>
        </div>

        <div id="screen-modes" class="screen interactive hidden">
            <div class="panel">
                <h1>MODUS WÃ„HLEN</h1>
                <button class="btn" onclick="initGame('normal')">NORMAL</button>
                <button class="btn" onclick="initGame('hardcore')" style="color:var(--danger)">HARDCORE</button>
                <button class="btn" onclick="initGame('coinmaster')" style="color:var(--gold)">COIN FARMER</button>
                <button class="btn" onclick="initGame('laser')" style="color:var(--neon)">LASER ZONE</button>
                <button class="btn" onclick="showScreen('screen-main')" style="background:#4b5563">ZURÃœCK</button>
            </div>
        </div>

        <div id="screen-shop" class="screen interactive hidden">
            <div class="panel">
                <h1>UPGRADES</h1>
                <p>Deine Coins: <span id="shopCoins" style="color:var(--gold)">0</span></p>
                <div class="shop-grid" id="shopContent"></div>
                <button class="btn" onclick="showScreen('screen-main')">ZURÃœCK</button>
            </div>
        </div>

        <div id="screen-over" class="screen interactive hidden">
            <div class="panel">
                <h1 style="color:var(--danger)">CRASH!</h1>
                <p>Score: <span id="finalScore">0</span></p>
                <button class="btn" onclick="showScreen('screen-modes')">NOCHMAL</button>
                <button class="btn" onclick="location.reload()" style="background:#4b5563">MENÃœ</button>
            </div>
        </div>
    </div>

    <script>
        // --- Persistence & Shop Data ---
        let gameData = JSON.parse(localStorage.getItem('ultra3D_vMaster')) || {
            coins: 0, highscore: 0, owned: ['Standard'], activeSkin: 'Standard'
        };

        const skins = [
            { name: 'Standard', color: 0x3b82f6, price: 0 },
            { name: 'Neon Pink', color: 0xec4899, price: 100 },
            { name: 'Gold Cube', color: 0xfbbf24, price: 500 },
            { name: 'Emerald', color: 0x10b981, price: 300 }
        ];

        // --- 3D Engine Vars ---
        let scene, camera, renderer, player, floor;
        let obstacles = [], coins = [], bullets = [], particles = [], clock = new THREE.Clock();
        let gameState = "menu", currentMode = "normal", score = 0, speed = 0.7, lane = 0;

        function init3D() {
            scene = new THREE.Scene();
            scene.fog = new THREE.Fog(0x020617, 20, 80);
            camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 10);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio > 1 ? 1.5 : 1);
            document.body.appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            let sun = new THREE.DirectionalLight(0xffffff, 1); sun.position.set(5, 10, 5); scene.add(sun);

            player = new THREE.Mesh(new THREE.BoxGeometry(1.2, 1.2, 1.2), new THREE.MeshPhongMaterial({ color: 0x3b82f6 }));
            player.position.y = 0.6; scene.add(player);

            floor = new THREE.Mesh(new THREE.PlaneGeometry(40, 2000), new THREE.MeshPhongMaterial({ color: 0x050810 }));
            floor.rotation.x = -Math.PI/2; scene.add(floor);

            document.getElementById('bestVal').innerText = gameData.highscore;
            document.getElementById('totalCoinsVal').innerText = gameData.coins;
            
            animate();
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            if(id === 'screen-shop') renderShop();
        }

        function renderShop() {
            document.getElementById('shopCoins').innerText = gameData.coins;
            let html = '';
            skins.forEach(s => {
                const isOwned = gameData.owned.includes(s.name);
                const isActive = gameData.activeSkin === s.name;
                html += `<div class="shop-item ${isActive?'active':''}" onclick="buySkin('${s.name}')">
                    ${s.name}<br>${isActive ? 'AKTIV' : (isOwned ? 'NUTZEN' : s.price + ' ðŸ’°')}
                </div>`;
            });
            document.getElementById('shopContent').innerHTML = html;
        }

        function buySkin(name) {
            const s = skins.find(x => x.name === name);
            if(gameData.owned.includes(name)) gameData.activeSkin = name;
            else if(gameData.coins >= s.price) {
                gameData.coins -= s.price; gameData.owned.push(name); gameData.activeSkin = name;
            }
            save(); renderShop();
        }

        function initGame(mode) {
            currentMode = mode; gameState = "playing"; score = 0; lane = 0;
            speed = (mode === 'hardcore' ? 1.0 : mode === 'laser' ? 1.2 : 0.7);
            
            const s = skins.find(x => x.name === gameData.activeSkin);
            player.material.color.setHex(s.color);

            [obstacles, coins, bullets, particles].forEach(arr => { arr.forEach(o => scene.remove(o)); arr.length = 0; });
            
            document.getElementById('modeDisplay').innerText = "MODUS: " + mode.toUpperCase();
            document.getElementById('coinVal').innerText = gameData.coins;
            showScreen('none');
            document.getElementById('hud').classList.remove('hidden');
        }

        function spawnExplosion(pos) {
            for(let i=0; i<5; i++) {
                let p = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.3, 0.3), new THREE.MeshBasicMaterial({color: 0xef4444}));
                p.position.copy(pos);
                p.userData = { vel: new THREE.Vector3((Math.random()-0.5)*0.3, Math.random()*0.3, (Math.random()-0.5)*0.3), life: 1.0 };
                scene.add(p); particles.push(p);
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            if (gameState === "playing") {
                score += 0.1;
                speed += 0.0002;
                document.getElementById('scoreVal').innerText = Math.floor(score);
                player.position.x = THREE.MathUtils.lerp(player.position.x, lane * 3.5, 0.15);

                // Obstacles (nicht im Coin Master)
                if(currentMode !== 'coinmaster' && Math.random() < (currentMode === 'laser' ? 0.05 : 0.03)) {
                    let o = new THREE.Mesh(new THREE.BoxGeometry(currentMode==='laser'?1.5:2.8, 2, 1), new THREE.MeshPhongMaterial({ color: 0xef4444 }));
                    o.position.set((Math.floor(Math.random()*3)-1)*3.5, 1, -80);
                    scene.add(o); obstacles.push(o);
                }

                // Bullet Physics
                bullets.forEach((b, bi) => {
                    b.position.z -= 2.5;
                    obstacles.forEach((o, oi) => {
                        if(b.position.distanceTo(o.position) < 2.2) {
                            spawnExplosion(o.position);
                            scene.remove(o); obstacles.splice(oi, 1);
                            scene.remove(b); bullets.splice(bi, 1);
                        }
                    });
                });

                // Entity Movement
                [obstacles, coins].forEach(arr => {
                    for(let i = arr.length-1; i>=0; i--) {
                        arr[i].position.z += speed;
                        if(arr[i].position.distanceTo(player.position) < 1.5) {
                            if(arr === coins) {
                                gameData.coins += 25; document.getElementById('coinVal').innerText = gameData.coins;
                                scene.remove(arr[i]); arr.splice(i,1);
                            } else gameOver();
                        } else if(arr[i].position.z > 15) { scene.remove(arr[i]); arr.splice(i,1); }
                    }
                });

                // Spawn Coins
                if(Math.random() < (currentMode === 'coinmaster' ? 0.08 : 0.02)) {
                    let c = new THREE.Mesh(new THREE.TorusGeometry(0.4, 0.1), new THREE.MeshBasicMaterial({color: 0xfbbf24}));
                    c.position.set((Math.floor(Math.random()*3)-1)*3.5, 1, -80);
                    scene.add(c); coins.push(c);
                }

                // Particles
                particles.forEach((p, i) => {
                    p.position.add(p.userData.vel); p.userData.life -= 0.02;
                    if(p.userData.life <= 0) { scene.remove(p); particles.splice(i,1); }
                });

                camera.lookAt(player.position.x, 1, 0);
            }
            renderer.render(scene, camera);
        }

        function gameOver() {
            gameState = "over";
            if(score > gameData.highscore) gameData.highscore = Math.floor(score);
            save();
            document.getElementById('finalScore').innerText = Math.floor(score);
            showScreen('screen-over');
        }

        function save() { localStorage.setItem('ultra3D_vMaster', JSON.stringify(gameData)); }

        window.addEventListener('mousedown', (e) => {
            if (gameState === "playing" && e.button === 0) {
                let b = new THREE.Mesh(new THREE.SphereGeometry(0.3), new THREE.MeshBasicMaterial({ color: 0x00f2ff }));
                b.position.set(player.position.x, 0.8, -1); scene.add(b); bullets.push(b);
            }
        });

        window.addEventListener('keydown', (e) => {
            if (gameState !== "playing") return;
            if ((e.key === 'a' || e.key === 'ArrowLeft') && lane > -1) lane--;
            if ((e.key === 'd' || e.key === 'ArrowRight') && lane < 1) lane++;
            if (e.key === ' ') player.position.y = 3; // Notsprung
        });

        init3D();
    </script>
</body>
</html>
